name: Build and test Postgres Standard Library

on:
  push:
    branches:
      - 1.67.1
  pull_request:
    branches:
      - 1.67.1

jobs:
  test_x86_84:
    name: "x86_64 (cross: aarch64) build & test"
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install system dependencies
      run: |
        sudo apt-get install -y \
          clang-11 \
          llvm-11 \
          clang \
          gcc \
          make \
          build-essential \
          libz-dev \
          zlib1g-dev \
          strace \
          libssl-dev \
          pkg-config \
          crossbuild-essential-arm64

    - name: Install rust
      run: |
        export RUSTUP_HOME="$HOME/.rustup"
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source "$HOME/.cargo/env"
        cargo --version

    - name: Update postgrestd git submodules
      run: git submodule update --init --recursive

    - name: Build postgrestd
      run: ./run install
      env:
        CARGO_TARGET_AARCH64_POSTGRES_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        CARGO_TARGET_X86_64_POSTGRES_LINUX_GNU_LINKER: cc

  test_aarch64:
    name: "aarch64 (cross: x86_64) build & test"
    runs-on: [self-hosted, linux, ARM64, postgrestd]

    # env:
    #   STD_TARGETS: aarch64-postgres-linux-gnu

    steps:
    - uses: actions/checkout@v3

    - name: Show kernel info
      run: uname -a

    - name: Print env
      run: env

    - name: Install system dependencies
      run: |
        sudo apt-get install -y \
          clang-11 \
          llvm-11 \
          clang \
          gcc \
          make \
          build-essential \
          libz-dev \
          zlib1g-dev \
          strace \
          libssl-dev \
          pkg-config \
          crossbuild-essential-arm64

    - name: Install rust
      run: |
        export RUSTUP_HOME="$HOME/.rustup"
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source "$HOME/.cargo/env"
        echo "RUSTUP_HOME=$HOME/.rustup" >> $GITHUB_ENV
        echo "PATH=$HOME/.cargo/bin:$PATH" >> $GITHUB_ENV
        cargo --version

    - name: Update postgrestd git submodules
      run: git submodule update --init --recursive

    - name: Build postgrestd
      # run: STD_TARGETS=aarch64-postgres-linux-gnu ./run install
      run: CARGO_TARGET_AARCH64_POSTGRES_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc CARGO_TARGET_X86_64_POSTGRES_LINUX_GNU_LINKER=cc ./run install
      # env:
      #   CARGO_TARGET_AARCH64_POSTGRES_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
      #   CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
      #   CARGO_TARGET_X86_64_POSTGRES_LINUX_GNU_LINKER: cc
